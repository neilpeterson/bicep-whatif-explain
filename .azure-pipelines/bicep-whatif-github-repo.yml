# Azure DevOps Pipeline for Bicep What-If Analysis
# Repository: GitHub (not Azure Repos)
#
# This example shows how to use bicep-whatif-advisor when your repository
# is hosted on GitHub but you're using Azure DevOps Pipelines.
#
# Key Difference: You must use GITHUB_TOKEN for PR comments, not SYSTEM_ACCESSTOKEN

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - bicep/*

pr:
  branches:
    include:
      - main
  paths:
    include:
      - bicep/*

pool:
  vmImage: ubuntu-latest

variables:
  BICEP_TEMPLATE: bicep/main.bicep
  BICEP_PARAMS: bicep/main.bicepparam

stages:
  - stage: WhatIfReview
    displayName: 'What-If Review'
    jobs:
      - job: Review
        displayName: 'AI Safety Review'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: AzureCLI@2
            displayName: 'What-If Analysis & AI Review'
            inputs:
              azureSubscription: 'my-service-connection'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                # Install the tool
                pip install bicep-whatif-advisor[anthropic]

                # Run What-If analysis and pipe to AI advisor
                az deployment group what-if \
                  --resource-group $(RESOURCE_GROUP) \
                  --template-file $(BICEP_TEMPLATE) \
                  --parameters $(BICEP_PARAMS) \
                  --exclude-change-types NoChange Ignore \
                  | bicep-whatif-advisor
            env:
              # Anthropic API key for AI analysis
              ANTHROPIC_API_KEY: $(ANTHROPIC_API_KEY)

              # IMPORTANT: For GitHub repositories, use GITHUB_TOKEN
              # NOT SYSTEM_ACCESSTOKEN (which only works for Azure Repos)
              GITHUB_TOKEN: $(GITHUB_TOKEN)

# Variable Setup Instructions:
#
# 1. Create a GitHub Personal Access Token:
#    - Go to GitHub Settings → Developer settings → Personal access tokens
#    - Generate new token (classic) with 'repo' scope
#    - Or use fine-grained token with pull requests write permission
#
# 2. Add variables in Azure DevOps:
#    - Pipelines → Library → Variable groups → New variable group
#    - Name: "bicep-whatif-vars"
#    - Variables:
#      * ANTHROPIC_API_KEY (secret) - From https://console.anthropic.com/
#      * GITHUB_TOKEN (secret) - GitHub PAT from step 1
#      * RESOURCE_GROUP (plain) - Your Azure resource group name
#
# 3. Link variable group to pipeline:
#    - Add this under 'variables:' section above:
#      - group: bicep-whatif-vars

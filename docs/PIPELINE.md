# CI/CD Pipeline Integration

This guide shows how to integrate `whatif-explain` into your CI/CD pipelines as an automated deployment gate.

## Overview

In CI mode, `whatif-explain` evaluates both the Azure What-If output and your source code changes to provide:

- **Risk Assessment** - Evaluates three independent risk buckets (drift, intent, operations)
- **Safety Verdict** - Determines if deployment should proceed based on configurable thresholds
- **PR Comments** - Posts detailed summary to pull requests
- **Exit Codes** - Blocks unsafe deployments automatically

### Risk Bucket System

CI mode evaluates three independent risk categories:

1. **Infrastructure Drift** - Detects changes in What-If output that aren't in the code diff (out-of-band modifications)
2. **PR Intent Alignment** - Compares What-If changes to PR description to catch unintended changes
3. **Risky Operations** - Identifies inherently dangerous Azure operations (deletions, security changes)

Each bucket has an independent risk threshold (low, medium, high). Deployment fails if ANY bucket exceeds its threshold.

## GitHub Actions

### Complete Example

```yaml
name: Infrastructure Deployment

on:
  pull_request:
    paths:
      - 'infra/**'
  push:
    branches:
      - main

jobs:
  whatif-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Required for PR comments
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for git diff

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install whatif-explain
        run: pip install whatif-explain[anthropic]

      - name: Run What-If
        run: |
          az deployment group what-if \
            --resource-group my-rg \
            --template-file infra/main.bicep \
            --parameters infra/parameters.json \
            --exclude-change-types NoChange Ignore \
            > whatif-output.txt

      - name: AI Review & Deployment Gate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat whatif-output.txt | whatif-explain \
            --ci \
            --diff-ref origin/main \
            --bicep-dir infra/ \
            --drift-threshold high \
            --intent-threshold high \
            --operations-threshold high \
            --post-comment \
            --format markdown

      - name: Deploy (only if safe)
        if: success() && github.ref == 'refs/heads/main'
        run: |
          az deployment group create \
            --resource-group my-rg \
            --template-file infra/main.bicep \
            --parameters infra/parameters.json
```

### Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `ANTHROPIC_API_KEY` | Yes | Set in repository secrets |
| `GITHUB_TOKEN` | Auto | Automatically provided by GitHub Actions |
| `GITHUB_REPOSITORY` | Auto | Automatically set (format: owner/repo) |
| `GITHUB_REF` | Auto | Automatically set (contains PR number) |

### Required Permissions

Add to your workflow file:

```yaml
permissions:
  contents: read
  pull-requests: write  # Needed for posting PR comments
```

### Setup Steps

1. **Add Anthropic API Key to GitHub Secrets:**
   - Go to repository Settings → Secrets and variables → Actions
   - Add secret named `ANTHROPIC_API_KEY`
   - Get your API key from https://console.anthropic.com/

2. **Add Azure Credentials:**
   - Create a service principal: `az ad sp create-for-rbac --name "github-actions" --role contributor --scopes /subscriptions/{subscription-id}`
   - Add the JSON output as `AZURE_CREDENTIALS` secret

3. **Commit the workflow file to `.github/workflows/deploy.yml`**

### PR Comment Example

When a PR is created, you'll see a comment like:

```markdown
## What-If Deployment Review

### Risk Assessment

| Risk Bucket | Risk Level | Key Concerns |
|-------------|------------|--------------|
| Infrastructure Drift | Low | None |
| PR Intent Alignment | Low | None |
| Risky Operations | Low | None |

### Resource Changes

| # | Resource | Type | Action | Risk | Summary |
|---|----------|------|--------|------|---------|
| 1 | applicationinsights | APIM Diagnostic | Create | Low | Configures App Insights logging... |

**Summary:** This deployment creates JWT authentication policies, updates diagnostic logging, and enhances API security.

### Verdict: ✅ SAFE

**Overall Risk Level:** Low
**Highest Risk Bucket:** Operations
**Reasoning:** All changes are adding new monitoring and diagnostic resources without modifying existing infrastructure.

---
*Generated by whatif-explain*
```

## Azure DevOps Pipelines

### Complete Example

```yaml
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - infra/*

pr:
  branches:
    include:
      - main
  paths:
    include:
      - infra/*

pool:
  vmImage: ubuntu-latest

stages:
  - stage: WhatIfReview
    displayName: 'What-If Review'
    jobs:
      - job: Review
        displayName: 'AI Safety Review'
        steps:
          - checkout: self
            fetchDepth: 0  # Needed for git diff

          - task: AzureCLI@2
            displayName: 'Run What-If'
            inputs:
              azureSubscription: 'my-service-connection'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az deployment group what-if \
                  --resource-group my-rg \
                  --template-file infra/main.bicep \
                  --parameters infra/parameters.json \
                  --exclude-change-types NoChange Ignore \
                  > $(Build.ArtifactStagingDirectory)/whatif-output.txt

          - task: Bash@3
            displayName: 'Install whatif-explain'
            inputs:
              targetType: inline
              script: pip install whatif-explain[anthropic]

          - task: Bash@3
            displayName: 'AI Review & Deployment Gate'
            env:
              ANTHROPIC_API_KEY: $(ANTHROPIC_API_KEY)
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)
            inputs:
              targetType: inline
              script: |
                cat $(Build.ArtifactStagingDirectory)/whatif-output.txt | whatif-explain \
                  --ci \
                  --diff-ref origin/main \
                  --bicep-dir infra/ \
                  --drift-threshold high \
                  --intent-threshold high \
                  --operations-threshold high \
                  --post-comment \
                  --format markdown

  - stage: Deploy
    displayName: 'Deploy Infrastructure'
    dependsOn: WhatIfReview
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployInfra
        displayName: 'Deploy to Azure'
        environment: production
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Deploy Infrastructure'
                  inputs:
                    azureSubscription: 'my-service-connection'
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az deployment group create \
                        --resource-group my-rg \
                        --template-file infra/main.bicep \
                        --parameters infra/parameters.json
```

### Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `ANTHROPIC_API_KEY` | Yes | Set in pipeline variables |
| `SYSTEM_ACCESSTOKEN` | Auto | Enable in pipeline settings |
| `SYSTEM_COLLECTIONURI` | Auto | Automatically set |
| `SYSTEM_TEAMPROJECT` | Auto | Automatically set |
| `SYSTEM_PULLREQUEST_PULLREQUESTID` | Auto | Automatically set |
| `BUILD_REPOSITORY_ID` | Auto | Automatically set |

### Setup Steps

1. **Add Anthropic API Key to Pipeline Variables:**
   - Go to Pipelines → Edit → Variables
   - Add variable `ANTHROPIC_API_KEY` (mark as secret)
   - Get your API key from https://console.anthropic.com/

2. **Enable System.AccessToken:**
   - In your pipeline YAML, ensure `SYSTEM_ACCESSTOKEN: $(System.AccessToken)` is set
   - Or enable "Allow scripts to access the OAuth token" in pipeline settings

3. **Create Azure Service Connection:**
   - Go to Project Settings → Service connections
   - Add new Azure Resource Manager connection
   - Name it `my-service-connection` (or update YAML)

4. **Create Production Environment:**
   - Go to Pipelines → Environments
   - Create environment named `production`
   - Add approvals if desired

## Risk Thresholds

Configure three independent thresholds to control when deployments are blocked. Each threshold operates on its respective risk bucket:

```bash
# All three thresholds (default: high for production safety)
--drift-threshold high          # Block if drift risk >= high
--intent-threshold high         # Block if intent misalignment >= high
--operations-threshold high     # Block if operations risk >= high

# Example: Strict drift detection, lenient operations
--drift-threshold low           # Catch any drift
--intent-threshold medium       # Moderate intent checking
--operations-threshold high     # Only block dangerous ops
```

### Risk Bucket Definitions

**1. Infrastructure Drift**
- **High:** Critical resources drifting (security, identity, stateful resources), broad scope drift
- **Medium:** Multiple resources drifting, configuration drift on important resources
- **Low:** Minor drift (tags, display names), single resource drift on non-critical resources

**2. PR Intent Alignment** *(requires --pr-title or --pr-description)*
- **High:** Destructive changes not mentioned in PR, security/auth changes not mentioned
- **Medium:** Resource modifications not aligned with PR intent, unexpected resource types
- **Low:** New resources not mentioned but aligned with intent, minor scope differences

**3. Risky Operations**
- **High:** Deletion of stateful resources (databases, storage, key vaults), RBAC deletions, broad network security changes, encryption changes, SKU downgrades
- **Medium:** Behavioral changes to existing resources, new public endpoints, firewall changes, policy modifications
- **Low:** Adding resources, tags, monitoring resources, cosmetic changes

## Best Practices

### 1. Use on Pull Requests

Run What-If review on every PR to catch issues early:

```yaml
on:
  pull_request:
    paths:
      - 'infra/**'
```

### 2. Exclude NoChange Resources

Reduce noise by excluding unchanged resources:

```bash
az deployment group what-if \
  --exclude-change-types NoChange Ignore
```

### 3. Set Appropriate Risk Thresholds

**Development/Staging:**
```bash
--drift-threshold medium \
--intent-threshold medium \
--operations-threshold medium
```

**Production (Recommended):**
```bash
--drift-threshold high \
--intent-threshold high \
--operations-threshold high
```

**Strict Drift Detection (catch any out-of-band changes):**
```bash
--drift-threshold low \
--intent-threshold high \
--operations-threshold high
```

### 4. Review PR Comments

The AI provides context and recommendations—review them before merging.

### 5. Keep Bicep Organized

The `--bicep-dir` flag includes source files in the analysis. Keep your Bicep files well-organized for better AI understanding.

### 6. Test Locally First

Test the command locally before adding to CI:

```bash
az deployment group what-if ... | whatif-explain \
  --ci \
  --diff-ref main \
  --drift-threshold high \
  --intent-threshold high \
  --operations-threshold high
```

## Workflow Patterns

### Pattern 1: Review Only (No Auto-Deploy)

```yaml
# GitHub Actions
- name: Review Only
  run: |
    cat whatif-output.txt | whatif-explain \
      --ci \
      --post-comment \
      --drift-threshold high \
      --intent-threshold high \
      --operations-threshold high
```

No deployment step—use for informational reviews.

### Pattern 2: Review + Auto-Deploy on Main

```yaml
# Deploy only if safe AND on main branch
- name: Deploy
  if: success() && github.ref == 'refs/heads/main'
  run: az deployment group create ...
```

### Pattern 3: Review + Manual Approval

```yaml
# Azure DevOps
- deployment: DeployInfra
  environment: production  # Requires manual approval
  condition: succeeded()
```

Use Azure DevOps environments with approval gates.

### Pattern 4: Multi-Environment

```yaml
# Different risk thresholds per environment
- name: Review (Dev)
  if: contains(github.ref, 'develop')
  run: |
    whatif-explain --ci \
      --drift-threshold medium \
      --intent-threshold medium \
      --operations-threshold medium

- name: Review (Prod)
  if: contains(github.ref, 'main')
  run: |
    whatif-explain --ci \
      --drift-threshold high \
      --intent-threshold high \
      --operations-threshold high
```

## Troubleshooting

### PR comments not posting

**GitHub Actions:**
- Check `permissions.pull-requests: write` is set
- Verify `GITHUB_TOKEN` has correct permissions

**Azure DevOps:**
- Ensure `SYSTEM_ACCESSTOKEN: $(System.AccessToken)` is set
- Enable "Allow scripts to access the OAuth token" in pipeline settings

### Exit code 1 (unsafe) when it should be safe

- Check which risk bucket failed (shown in stderr)
- Review threshold settings for all three buckets
- Review the verdict in output or PR comment
- The LLM may be overly conservative—adjust thresholds if needed
- Consider setting different thresholds per bucket based on your risk tolerance

### Git diff errors

- Ensure `fetch-depth: 0` in checkout step
- Verify `--diff-ref` points to valid branch/commit
- Check branch protection rules

### Large What-If output

Input is truncated to 100,000 characters. If needed:
- Use `--exclude-change-types NoChange Ignore`
- Break deployments into smaller scopes

## Advanced Configuration

### Custom Models

```bash
# Use Claude Opus for more complex analysis
whatif-explain --ci --model claude-opus-4-20250101

# Use Azure OpenAI
whatif-explain --ci --provider azure-openai
```

### Multiple Scopes

Review multiple resource groups:

```bash
# Run What-If for each scope
az deployment group what-if -g rg-1 ... > whatif-rg-1.txt
az deployment group what-if -g rg-2 ... > whatif-rg-2.txt

# Review each separately
cat whatif-rg-1.txt | whatif-explain --ci
cat whatif-rg-2.txt | whatif-explain --ci
```

### Save Reviews

Store reviews as artifacts:

```yaml
# GitHub Actions
- name: Upload Review
  uses: actions/upload-artifact@v4
  with:
    name: whatif-review
    path: whatif-output.txt
```

## Support

For issues or questions, refer to the project documentation in the repository.

## Related Tools

- **Azure CLI:** https://docs.microsoft.com/cli/azure/
- **Bicep:** https://learn.microsoft.com/azure/azure-resource-manager/bicep/
- **What-If:** https://learn.microsoft.com/azure/azure-resource-manager/bicep/deploy-what-if
